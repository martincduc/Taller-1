<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Libre & Rico ‚Äî Tienda</title>
  <style>
    :root{
      --bg:#faf9fb;
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#0f172a;
      --brand:#1d4ed8;
      --brand-dark:#153ea9;
      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;
      --border:#e5e7eb;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
      --mono:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:var(--bg);
      opacity: 0;
      animation: fadeInBody 0.8s ease forwards;
    }

    @keyframes fadeInBody {
      to { opacity: 1; }
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:16px;
      padding:12px 16px; background:#fff;
      border-bottom:1px solid var(--border);
      transform: translateY(-10px);
      opacity: 0;
      animation: slideDownTopbar 0.6s ease 0.2s forwards;
    }

    @keyframes slideDownTopbar {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:linear-gradient(135deg,#111827,#334155);
      color:#fff; display:grid; place-items:center; font-weight:800;
      transition: var(--transition-normal);
      animation: logoPulse 2s ease-in-out infinite alternate;
    }

    @keyframes logoPulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }

    .logo:hover {
      animation: none;
      transform: scale(1.1) rotate(5deg);
    }

    .brand-text{display:flex; flex-direction:column; line-height:1.1}
    .brand-text span{font-size:12px; color:var(--muted)}

    .nav{display:flex; gap:10px; margin-left:12px}
    .nav-link{
      padding:8px 10px; border-radius:10px; cursor:pointer;
      color:#111; text-decoration:none; border:1px solid transparent;
      transition: var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: var(--transition-normal);
    }

    .nav-link:hover::before {
      left: 100%;
    }

    .nav-link:hover{background:#f3f4f6; transform: translateY(-2px);}
    .nav-link.active{
      border-color:var(--border); 
      background:#f9fafb;
      animation: activePulse 2s ease-in-out infinite;
    }

    @keyframes activePulse {
      0%, 100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
      50% { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
    }

    .actions{margin-left:auto; display:flex; gap:12px; align-items:center}
    .search{
      display:flex; border:1px solid var(--border); border-radius:12px; overflow:hidden;
      transition: var(--transition-normal);
    }
    .search:focus-within {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    .search input{
      border:0; padding:10px 12px; width:240px; outline:none;
      transition: var(--transition-normal);
    }
    .search button{
      border:0; padding:10px 12px; background:#f3f4f6; cursor:pointer;
      transition: var(--transition-normal);
    }
    .search button:hover {
      background: var(--brand);
      color: white;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-login {
      background: var(--brand);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition-normal);
    }

    .btn-login:hover {
      background: var(--brand-dark);
      transform: translateY(-2px);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition-normal);
    }

    .user-avatar:hover {
      transform: scale(1.1);
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--ink);
    }

    .user-dropdown {
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 8px;
      min-width: 150px;
      z-index: 1000;
      animation: dropdownAppear 0.2s ease;
    }

    @keyframes dropdownAppear {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      transition: var(--transition-fast);
      font-size: 14px;
    }

    .dropdown-item:hover {
      background: #f8fafc;
    }

    .dropdown-item.logout {
      color: var(--err);
    }

    .dropdown-item.logout:hover {
      background: #fef2f2;
    }

    .cart-btn{
      border:1px solid var(--border); background:#fff; padding:10px 12px;
      border-radius:12px; cursor:pointer; font-weight:600;
      transition: var(--transition-normal);
      position: relative;
    }

    .cart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .cart-btn::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: var(--brand);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
      transition: var(--transition-normal);
    }

    .cart-btn.has-items::after {
      opacity: 1;
      transform: scale(1);
    }

    main{
      max-width:1100px; margin:22px auto; padding:0 16px;
      animation: fadeInUp 0.8s ease 0.4s forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toolbar{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
      animation: slideInLeft 0.6s ease 0.6s forwards;
      opacity: 0;
      transform: translateX(-20px);
    }

    @keyframes slideInLeft {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .filters{display:flex; gap:8px; align-items:center}
    .filters select,.filters button{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;
      transition: var(--transition-normal);
    }

    .filters select:focus, .filters button:hover {
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .filters button:hover {
      background: var(--brand);
      color: white;
    }

    .grid{
      display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
    }
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr)} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; padding:12px;
      transition: var(--transition-normal);
      animation: cardAppear 0.6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
      cursor: pointer;
    }

    @keyframes cardAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }

    .card:nth-child(1) { animation-delay: 0.7s; }
    .card:nth-child(2) { animation-delay: 0.8s; }
    .card:nth-child(3) { animation-delay: 0.9s; }
    .card:nth-child(4) { animation-delay: 1.0s; }
    .card:nth-child(5) { animation-delay: 1.1s; }
    .card:nth-child(6) { animation-delay: 1.2s; }

    .pic{
      aspect-ratio: 1.4/1; border-radius:12px; overflow:hidden; background:#f3f4f6;
      transition: var(--transition-normal);
    }
    .pic img{
      width:100%; height:100%; object-fit:cover;
      transition: var(--transition-slow);
    }
    .card:hover .pic img {
      transform: scale(1.05);
    }
    .card h4{margin:10px 0 4px; font-size:16px}
    .price{font-weight:700}
    .stock{font-size:12px; color:var(--muted)}
    .stock.ok{color:var(--ok)}
    .stock.agotado{color:var(--err)}
    .row{display:flex; gap:8px; align-items:center; margin-top:8px}
    button{cursor:pointer}

    button.primario{
      background:var(--brand); border:0; color:#fff; padding:12px 14px; border-radius:12px; font-weight:700;
      transition: var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    button.primario::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: var(--transition-normal);
    }

    button.primario:hover::before {
      width: 100%;
      height: 100%;
    }

    button.primario:hover{
      background:var(--brand-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(29, 78, 216, 0.3);
    }

    button.mini{
      padding:10px 12px; border:1px solid var(--border); background:#fff; border-radius:10px;
      transition: var(--transition-normal);
    }

    button.mini:hover:not(:disabled) {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    button.mini:active {
      transform: translateY(0);
    }

    button:disabled{opacity:.5; cursor:not-allowed}

    .paginacion{
      display:flex; gap:8px; align-items:center; justify-content:center; margin:16px 0;
      animation: fadeIn 0.6s ease 1.3s forwards;
      opacity: 0;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .paginacion button{
      border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px;
      transition: var(--transition-normal);
    }

    .paginacion button:hover:not(:disabled) {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .view.hidden{display:none}

    .view {
      animation: viewSlideIn 0.5s ease forwards;
    }

    @keyframes viewSlideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .auth-container {
      max-width: 400px;
      margin: 40px auto;
      animation: slideInUp 0.6s ease forwards;
    }

    .auth-tabs {
      display: flex;
      background: #f8fafc;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-normal);
      font-weight: 600;
    }

    .auth-tab.active {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .auth-form {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .auth-form h2 {
      margin: 0 0 20px 0;
      text-align: center;
      color: var(--ink);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--ink);
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition-normal);
    }

    .form-group input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-auth {
      width: 100%;
      padding: 14px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-normal);
      margin-top: 10px;
    }

    .btn-auth:hover {
      background: var(--brand-dark);
      transform: translateY(-2px);
    }

    .auth-switch {
      text-align: center;
      margin-top: 20px;
      color: var(--muted);
    }

    .auth-switch a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-switch a:hover {
      text-decoration: underline;
    }

    .carrito-lista{display:flex; flex-direction:column; gap:10px}
    .carrito-item{
      display:grid; grid-template-columns:80px 1fr 140px 110px 100px; gap:10px;
      align-items:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:10px;
      transition: var(--transition-normal);
      animation: slideInRight 0.4s ease forwards;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .carrito-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .carrito-item img{width:80px;height:80px;object-fit:cover;border-radius:10px; transition: var(--transition-normal);}
    .carrito-item:hover img {
      transform: scale(1.1);
    }
    .carrito-item .name{font-weight:600}
    .carrito-item .unit{color:var(--muted);font-size:13px}
    .qty{display:flex; gap:6px; align-items:center}
    .qty button{
      width:34px;height:34px;border:1px solid var(--border); background:#fff; border-radius:10px;
      transition: var(--transition-fast);
    }
    .qty button:hover {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
    }
    .qty input{width:42px;text-align:center;border:1px solid var(--border);border-radius:8px;padding:8px 6px; transition: var(--transition-normal);}
    .qty input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    .carrito-item .sub{font-weight:700}
    .carrito-item .del{
      border:1px solid var(--err); color:var(--err); background:#fff; border-radius:10px; padding:8px 10px;
      transition: var(--transition-normal);
    }
    .carrito-item .del:hover {
      background: var(--err);
      color: white;
      transform: scale(1.05);
    }

    .carrito-resumen{display:flex; gap:8px; margin-top:10px}
    .pill{
      display:inline-block; background:#f3f4f6; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:600;
      transition: var(--transition-normal);
    }
    .pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .pill-row{display:flex; gap:8px; margin:10px 0}

    .carrito-acciones{display:flex; gap:10px; margin-top:10px}

    .two{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .box{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px;
      transition: var(--transition-normal);
      animation: boxAppear 0.5s ease forwards;
    }

    @keyframes boxAppear {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .box:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .box h3{margin-top:0}

    label{display:block; font-size:13px; color:var(--muted); margin-top:8px}
    input,select{
      width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; margin-top:4px;
      transition: var(--transition-normal);
    }
    input:focus, select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .msg{
      border-radius:12px; padding:12px; border:1px solid var(--border); background:#f9fafb; margin-top:10px;
      animation: messagePopIn 0.4s ease forwards;
    }

    @keyframes messagePopIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .msg.ok{background:#eafcf0; color:#065f46; border-color:#b7f0c8}
    .msg.err{background:#fee2e2; color:#7f1d1d; border-color:#fecaca}
    .msg.warn{background:#fef3c7; color:#78350f; border-color:#fde68a}
    .msg.hidden{display:none}
    .muted{color:var(--muted)}

    .pay-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:8px 0}
    .pay-option{
      padding:14px; border:1px solid var(--border); border-radius:12px; background:#fff;
      transition: var(--transition-normal);
    }
    .pay-option:hover{
      border-color:#cbd5e1; background:#f8fafc;
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    .foot{
      margin-top:28px; border-top:1px solid var(--border); padding:16px; display:flex; gap:12px;
      color:var(--muted); font-size:14px; justify-content:center;
      animation: fadeIn 0.8s ease 1.4s forwards;
      opacity: 0;
    }

    .producto-detalle {
      animation: slideInUp 0.6s ease forwards;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn-volver {
      background: none;
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-volver:hover {
      background: #f8fafc;
      transform: translateX(-5px);
    }

    .producto-contenido {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      align-items: start;
    }

    @media (max-width: 768px) {
      .producto-contenido {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .producto-imagen {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #f8fafc;
      animation: imageReveal 0.8s ease 0.2s forwards;
      opacity: 0;
      transform: scale(0.95);
    }

    @keyframes imageReveal {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .producto-imagen img {
      width: 100%;
      height: 400px;
      object-fit: cover;
      transition: var(--transition-slow);
    }

    .producto-imagen:hover img {
      transform: scale(1.05);
    }

    .producto-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--brand);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      animation: badgePulse 2s ease-in-out infinite;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .producto-info {
      animation: contentSlideIn 0.6s ease 0.4s forwards;
      opacity: 0;
      transform: translateX(20px);
    }

    @keyframes contentSlideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .producto-info h1 {
      font-size: 28px;
      margin: 0 0 12px 0;
      color: var(--ink);
      line-height: 1.2;
    }

    .producto-precio {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      margin: 0 0 16px 0;
      animation: pricePop 0.6s ease 0.6s forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes pricePop {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .producto-stock {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      animation: fadeIn 0.6s ease 0.8s forwards;
      opacity: 0;
    }

    .producto-stock.disponible {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .producto-stock.agotado {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .producto-categoria {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 24px;
      animation: fadeIn 0.6s ease 1s forwards;
      opacity: 0;
    }

    .producto-acciones {
      background: #f8fafc;
      padding: 20px;
      border-radius: 16px;
      margin: 24px 0;
      animation: actionsAppear 0.6s ease 1.2s forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes actionsAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cantidad-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .qty-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-normal);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qty-btn:hover:not(:disabled) {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
      transform: scale(1.1);
    }

    .qty-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #productoQty {
      width: 80px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition-normal);
    }

    #productoQty:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: scale(1.05);
    }

    .btn-agregar {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .btn-agregar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: var(--transition-normal);
    }

    .btn-agregar:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-agregar:active {
      transform: scale(0.98);
    }

    .producto-descripcion {
      animation: fadeIn 0.6s ease 1.4s forwards;
      opacity: 0;
    }

    .producto-descripcion h3 {
      margin: 0 0 12px 0;
      color: var(--ink);
    }

    .producto-descripcion p {
      line-height: 1.6;
      color: var(--muted);
      margin: 0;
    }

    .agregado-exitoso {
      animation: successAdd 0.6s ease;
    }

    @keyframes successAdd {
      0% {
        transform: scale(1);
        background: var(--brand);
      }
      50% {
        transform: scale(1.05);
        background: var(--ok);
      }
      100% {
        transform: scale(1);
        background: var(--brand);
      }
    }

    .badge-nuevo {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .badge-oferta {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .badge-popular {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    @keyframes addToCart {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .added-to-cart {
      animation: addToCart 0.4s ease;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">L&Rüçû</div>
      <div class="brand-text">
        <strong>Libre & Rico</strong>
        <span>Panificados sin gluten</span>
      </div>
    </div>

    <nav class="nav">
      <a data-route="catalogo" class="nav-link active">Inicio</a>
      <a data-route="catalogo" class="nav-link">Cat√°logo</a>
      <a data-route="seguimiento" class="nav-link">Seguimiento</a>
    </nav>

    <div class="actions">
      <div class="search">
        <input id="q" placeholder="Buscar productos‚Ä¶"/>
        <button id="btnBuscar">üîç</button>
      </div>
      
      <div class="user-section" id="userSection">
        <button class="btn-login" id="btnShowLogin">Iniciar Sesi√≥n</button>
      </div>

      <button class="cart-btn" data-route="carrito">
        üõí <span id="cartCount">0</span>
      </button>
    </div>
  </header>

  <main>
    <section id="view-auth" class="view hidden">
      <div class="auth-container">
        <div class="auth-tabs">
          <button class="auth-tab active" data-tab="login">Iniciar Sesi√≥n</button>
          <button class="auth-tab" data-tab="register">Registrarse</button>
        </div>

        <div id="auth-login" class="auth-form">
          <h2>Bienvenido de nuevo</h2>
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="tu@email.com">
          </div>
          <div class="form-group">
            <label for="loginPassword">Contrase√±a</label>
            <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
          </div>
          <button class="btn-auth" id="btnLogin">Iniciar Sesi√≥n</button>
          <div class="auth-switch">
            ¬øNo tienes cuenta? <a id="switchToRegister">Reg√≠strate aqu√≠</a>
          </div>
          <div id="loginMessage" class="msg hidden"></div>
        </div>

        <div id="auth-register" class="auth-form hidden">
          <h2>Crear cuenta nueva</h2>
          <div class="form-group">
            <label for="registerName">Nombre completo</label>
            <input type="text" id="registerName" placeholder="Tu nombre completo">
          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" placeholder="tu@email.com">
          </div>
          <div class="form-group">
            <label for="registerPassword">Contrase√±a</label>
            <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres">
          </div>
          <div class="form-group">
            <label for="registerConfirm">Confirmar contrase√±a</label>
            <input type="password" id="registerConfirm" placeholder="Repite tu contrase√±a">
          </div>
          <button class="btn-auth" id="btnRegister">Crear Cuenta</button>
          <div class="auth-switch">
            ¬øYa tienes cuenta? <a id="switchToLogin">Inicia sesi√≥n aqu√≠</a>
          </div>
          <div id="registerMessage" class="msg hidden"></div>
        </div>
      </div>
    </section>

    <section id="view-catalogo" class="view">
      <div class="toolbar">
        <div class="filters">
          <select id="fCategoria">
            <option value="">Todas las categor√≠as</option>
          </select>
          <select id="fDisponibilidad">
            <option value="">Disponibilidad</option>
            <option value="stock">En stock</option>
            <option value="agotado">Agotado</option>
          </select>
          <select id="fOrden">
            <option value="destacados">Orden: Destacados</option>
            <option value="precioAsc">Precio ascendente</option>
            <option value="precioDesc">Precio descendente</option>
            <option value="nombre">Nombre</option>
          </select>
          <button id="aplicarFiltros">Aplicar filtros</button>
        </div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="paginacion">
        <button id="prevPag">‚óÄ</button>
        <span id="pagInfo"></span>
        <button id="nextPag">‚ñ∂</button>
      </div>
    </section>

    <section id="view-producto" class="view hidden">
      <div class="producto-detalle">
        <button class="btn-volver" data-route="catalogo">‚Üê Volver al cat√°logo</button>
        
        <div class="producto-contenido">
          <div class="producto-imagen">
            <img id="productoImg" src="" alt=""/>
            <div class="producto-badge" id="productoBadge"></div>
          </div>
          
          <div class="producto-info">
            <h1 id="productoNombre"></h1>
            <div class="producto-precio" id="productoPrecio"></div>
            <div class="producto-stock" id="productoStock"></div>
            <div class="producto-categoria" id="productoCategoria"></div>
            
            <div class="producto-acciones">
              <div class="cantidad-selector">
                <button class="qty-btn" id="qtyMenos">‚àí</button>
                <input type="number" id="productoQty" value="1" min="1" max="10"/>
                <button class="qty-btn" id="qtyMas">+</button>
              </div>
              <button class="primario btn-agregar" id="btnAgregarDetalle">
                üõí Agregar al carrito
              </button>
            </div>
            
            <div class="producto-descripcion">
              <h3>Descripci√≥n</h3>
              <p id="productoDesc"></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-carrito" class="view hidden">
      <h2>Mi carrito</h2>
      <div id="carritoLista" class="carrito-lista"></div>
      <div class="carrito-resumen">
        <div class="pill" id="pillSubtotal">$0</div>
        <div class="pill" id="pillDespacho">Despacho: $0</div>
        <div class="pill" id="pillTotal">Total: $0</div>
      </div>
      <div class="carrito-acciones">
        <button data-route="catalogo">Seguir comprando</button>
        <button class="primario" id="btnConfirmarPedido" data-route="checkout">Confirmar pedido</button>
      </div>
      <div id="msgCarrito" class="msg"></div>
    </section>

    <section id="view-checkout" class="view hidden">
      <h2>Confirmaci√≥n de pedido</h2>
      <div class="two">
        <div class="box">
          <h3>Resumen</h3>
          <pre id="resumenTxt"></pre>
        </div>
        <div class="box">
          <h3>Despacho y pago</h3>
          <label>Direcci√≥n</label>
          <input id="addr" placeholder="Av. Central 456, Santiago" value="Av. Central 456, Santiago"/>
          <label>M√©todo de pago</label>
          <select id="pay">
            <option value="webpay">Webpay</option>
            <option value="servipag">Servipag</option>
          </select>

          <div class="pill-row">
            <div class="pill" id="ckSubtotal">$0</div>
            <div class="pill" id="ckDespacho">Despacho: $0</div>
            <div class="pill" id="ckTotal">Total: $0</div>
          </div>

          <div class="row">
            <button data-route="carrito">Editar carrito</button>
            <button class="primario" id="goPasarela" data-route="pasarela">Ir a pagar</button>
          </div>

          <div id="ckWarn" class="msg warn hidden">Debes ingresar una direcci√≥n de despacho.</div>
          <div id="ckEmpty" class="msg err hidden">El carrito est√° vac√≠o.</div>
        </div>
      </div>
    </section>

    <section id="view-pasarela" class="view hidden">
      <h2>Pasarela de pago</h2>
      <div class="box">
        <p>Selecciona m√©todo de pago para el pedido <strong id="ordenId">#10100</strong></p>
        <div class="pay-grid">
          <button class="pay-option" data-result="AUTHORIZED">Tarjeta Visa</button>
          <button class="pay-option" data-result="REJECTED">Tarjeta Mastercard</button>
          <button class="pay-option" data-result="ERROR">D√©bito/Redcompra</button>
        </div>
        <p class="muted">Retorno pasarela: <span id="retornoText">‚Äî</span></p>
      </div>
      <div class="row">
        <button data-route="checkout">Volver</button>
      </div>
    </section>

    <section id="view-resultado" class="view hidden">
      <h2>Resultado de pago</h2>
      <div id="resOK" class="msg ok hidden">Pago recibido. Tu pedido fue marcado como <b>Pagado</b> y te enviamos la boleta digital.</div>
      <div id="resREJ" class="msg err hidden">Pago rechazado. El pedido sigue <b>Pendiente de pago</b>.</div>
      <div id="resERR" class="msg warn hidden">No se pudo procesar el pago, intenta nuevamente.</div>
      <div class="row">
        <button data-route="catalogo">Volver al cat√°logo</button>
        <button data-route="carrito">Ver carrito</button>
      </div>
    </section>

    <section id="view-seguimiento" class="view hidden">
      <h2>Seguimiento de pedido</h2>
      <div class="box">
        <div class="pill" id="segEstado">Estado actual: ‚Äî</div>
        <button id="btnActualizarSeg">Actualizar</button>
      </div>
      <div class="box">
        <h3>Historial de estados</h3>
        <ul id="segHist"></ul>
      </div>
    </section>
  </main>

  <footer class="foot">
    <span>¬© Libre & Rico</span>
  </footer>

  <script>
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);

    const routes = ["auth","catalogo","carrito","checkout","pasarela","resultado","seguimiento","producto"];

    const USERS_KEY = "lr:users";
    const CURRENT_USER_KEY = "lr:currentUser";
    
    const getUsers = () => JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
    const setUsers = (users) => localStorage.setItem(USERS_KEY, JSON.stringify(users));
    const getCurrentUser = () => JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || "null");
    const setCurrentUser = (user) => localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
    const logout = () => {
      localStorage.removeItem(CURRENT_USER_KEY);
      updateUserSection();
      go('catalogo');
    };

    const productos = [
      {id:"pan-molde", nombre:"Pan molde sin gluten 450g", precio:3990, stock:8, cat:"Pan", img:"https://unimarc.vtexassets.com/arquivos/ids/245777/000000000000671052-UN-01.jpg?v=638690279851670000"},
      {id:"galleta-avena", nombre:"Galletas de arroz", precio:2490, stock:0, cat:"Snack", img:"https://media.falabella.com/tottusCL/20241482_1/w=1500,h=1500,fit=pad"},
      {id:"pack-desayuno", nombre:"Pack desayuno (combo)", precio:6990, stock:3, cat:"Pack", img:"https://i.bolder.run/r/czoyNjc1LGc6MTAwMHg/69174c7d/972120-Dise%C3%B1o_sin_t%C3%ADtulo_%2818%29.jpg"},
      {id:"brownie-proteico", nombre:"Brownie proteico", precio:2990, stock:5, cat:"Postre", img:"https://i5.walmartimages.cl/asr/9fd1b99d-aae6-4d23-90dc-34602527319d.bcc836601a863fa7ab2e53c3786d0d17.jpeg?null=&odnHeight=612&odnWidth=612&odnBg=FFFFFF"},
      {id:"mix-semillado", nombre:"Pan semillado sin gluten", precio:4590, stock:6, cat:"Pan", img:"https://jumbocl.vtexassets.com/arquivos/ids/327059-900-900?width=900&height=900&aspect=true"},
      {id:"cookies-chips", nombre:"Cookies chips sin gluten", precio:3490, stock:10, cat:"Snack", img:"https://tendenciasgourmet.cl/cdn/shop/files/9eb45960-c24b-403b-b18b-a661eb41fce4-galleta-sin-gluten-chip-choco-gullon-130-gr.jpg?v=1726097410&width=480"}
    ];

    const LS_KEY="lr:cart";
    const getCart=()=>JSON.parse(localStorage.getItem(LS_KEY)||"[]");
    const setCart=v=>localStorage.setItem(LS_KEY,JSON.stringify(v));
    const money=n=>"$"+n.toLocaleString("es-CL");

    let pag=1,pageSize=6,cacheFiltro={};

    function updateUserSection() {
      const userSection = $("#userSection");
      const currentUser = getCurrentUser();
      
      if (currentUser) {
        userSection.innerHTML = `
          <div class="user-menu">
            <div class="user-dropdown">
              <div class="user-avatar">${currentUser.name.charAt(0).toUpperCase()}</div>
              <div class="dropdown-menu hidden">
                <button class="dropdown-item" data-route="seguimiento">Mis pedidos</button>
                <button class="dropdown-item logout" id="btnLogout">Cerrar sesi√≥n</button>
              </div>
            </div>
            <div class="user-name">Hola, ${currentUser.name.split(' ')[0]}</div>
          </div>
        `;
        
        $(".user-avatar").addEventListener('click', (e) => {
          e.stopPropagation();
          $(".dropdown-menu").classList.toggle('hidden');
        });
        
        $("#btnLogout").addEventListener('click', logout);
        
        document.addEventListener('click', () => {
          $(".dropdown-menu").classList.add('hidden');
        });
      } else {
        userSection.innerHTML = `
          <button class="btn-login" id="btnShowLogin">Iniciar Sesi√≥n</button>
        `;
        
        $("#btnShowLogin").addEventListener('click', () => {
          go('auth');
        });
      }
    }

    function go(route){
      routes.forEach(r=>{
        $("#view-"+r).classList.toggle("hidden", r!==route);
        $$('.nav-link').forEach(a=>a.classList.toggle('active',a.dataset.route===route));
      });
      history.replaceState(null,"","#"+route);
      
      if(route==="catalogo") pintarCatalogo();
      if(route==="carrito") pintarCarrito();
      if(route==="checkout") pintarCheckout();
      updateCartBadge();
    }

    function updateCartBadge() {
      const cart = getCart();
      const cartBtn = $('.cart-btn');
      if (cart.length > 0) {
        cartBtn.classList.add('has-items');
      } else {
        cartBtn.classList.remove('has-items');
      }
    }

    $$(".nav-link, [data-route]").forEach(x=>{
      if (!x.id || !x.id.includes('btn')) {
        x.addEventListener("click",e=>{
          go(e.currentTarget.dataset.route||"catalogo");
        });
      }
    });

    $$(".auth-tab").forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        $$(".auth-tab").forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        $$(".auth-form").forEach(form => form.classList.add('hidden'));
        $(`#auth-${tabName}`).classList.remove('hidden');
      });
    });

    $("#switchToRegister").addEventListener('click', () => {
      $$(".auth-tab").forEach(t => t.classList.remove('active'));
      $('[data-tab="register"]').classList.add('active');
      $("#auth-login").classList.add('hidden');
      $("#auth-register").classList.remove('hidden');
    });

    $("#switchToLogin").addEventListener('click', () => {
      $$(".auth-tab").forEach(t => t.classList.remove('active'));
      $('[data-tab="login"]').classList.add('active');
      $("#auth-register").classList.add('hidden');
      $("#auth-login").classList.remove('hidden');
    });

    $("#btnRegister").addEventListener('click', () => {
      const name = $("#registerName").value.trim();
      const email = $("#registerEmail").value.trim();
      const password = $("#registerPassword").value;
      const confirm = $("#registerConfirm").value;
      
      const msg = $("#registerMessage");
      msg.className = "msg hidden";
      
      if (!name || !email || !password || !confirm) {
        msg.textContent = "Todos los campos son obligatorios";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      if (password.length < 6) {
        msg.textContent = "La contrase√±a debe tener al menos 6 caracteres";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      if (password !== confirm) {
        msg.textContent = "Las contrase√±as no coinciden";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      if (!email.includes('@')) {
        msg.textContent = "Email inv√°lido";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      const users = getUsers();
      
      if (users.find(u => u.email === email)) {
        msg.textContent = "Este email ya est√° registrado";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      const newUser = {
        id: Date.now().toString(),
        name,
        email,
        password,
        createdAt: new Date().toISOString()
      };
      
      users.push(newUser);
      setUsers(users);
      setCurrentUser(newUser);
      
      msg.textContent = "¬°Cuenta creada exitosamente! Redirigiendo...";
      msg.classList.add('ok');
      msg.classList.remove('hidden');
      
      setTimeout(() => {
        updateUserSection();
        go('catalogo');
      }, 1500);
    });

    $("#btnLogin").addEventListener('click', () => {
      const email = $("#loginEmail").value.trim();
      const password = $("#loginPassword").value;
      
      const msg = $("#loginMessage");
      msg.className = "msg hidden";
      
      if (!email || !password) {
        msg.textContent = "Email y contrase√±a son obligatorios";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      const users = getUsers();
      const user = users.find(u => u.email === email && u.password === password);
      
      if (!user) {
        msg.textContent = "Email o contrase√±a incorrectos";
        msg.classList.add('err');
        msg.classList.remove('hidden');
        return;
      }
      
      setCurrentUser(user);
      
      msg.textContent = "¬°Inicio de sesi√≥n exitoso! Redirigiendo...";
      msg.classList.add('ok');
      msg.classList.remove('hidden');
      
      setTimeout(() => {
        updateUserSection();
        go('catalogo');
      }, 1000);
    });

    function seedFiltros(){
      const cats=[...new Set(productos.map(p=>p.cat))];
      cats.forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        $("#fCategoria").appendChild(o);
      });
    }

    function filtrarOrdenar(){
      let arr=[...productos];
      const q=$("#q").value.trim().toLowerCase();
      const c=$("#fCategoria").value;
      const d=$("#fDisponibilidad").value;
      const o=$("#fOrden").value;

      if(q) arr=arr.filter(p=>p.nombre.toLowerCase().includes(q));
      if(c) arr=arr.filter(p=>p.cat===c);
      if(d==="stock") arr=arr.filter(p=>p.stock>0);
      if(d==="agotado") arr=arr.filter(p=>p.stock===0);

      if(o==="precioAsc") arr.sort((a,b)=>a.precio-b.precio);
      if(o==="precioDesc") arr.sort((a,b)=>b.precio-a.precio);
      if(o==="nombre") arr.sort((a,b)=>a.nombre.localeCompare(b.nombre));

      cacheFiltro.arr=arr;
      cacheFiltro.pages=Math.max(1,Math.ceil(arr.length/pageSize));
      pag=Math.min(pag,cacheFiltro.pages);
    }

    function pintarCatalogo(){
      filtrarOrdenar();
      const start=(pag-1)*pageSize;
      const items=cacheFiltro.arr.slice(start,start+pageSize);
      const grid=$("#grid");
      grid.innerHTML="";
      items.forEach(p=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <div class="pic"><img src="${p.img}" alt="${p.nombre}"/></div>
          <h4>${p.nombre}</h4>
          <div class="price">${money(p.precio)}</div>
          <div class="stock ${p.stock>0?'ok':'agotado'}">${p.stock>0?('Stock: '+p.stock):'Agotado'}</div>
          <div class="row">
            <button class="mini btn-agregar-catalogo" data-id="${p.id}" ${p.stock?"":"disabled"}>Agregar</button>
            <button class="mini ver-detalle" data-id="${p.id}">Ver m√°s</button>
          </div>
        `;
        grid.appendChild(card);
      });
      $("#pagInfo").textContent=`P√°gina ${pag} de ${cacheFiltro.pages}`;
      $("#cartCount").textContent=cantidades().items;
      
      $$("#grid .btn-agregar-catalogo").forEach(b=>b.addEventListener("click",(e)=>{
        e.stopPropagation();
        agregar(b.dataset.id);
        b.classList.add('added-to-cart');
        setTimeout(() => b.classList.remove('added-to-cart'), 400);
      }));
      
      $$("#grid .ver-detalle").forEach(b=>b.addEventListener("click",(e)=>{
        e.stopPropagation();
        verProducto(b.dataset.id);
      }));
      
      $$("#grid .card").forEach(card=>{
        card.addEventListener('click', function() {
          const id = this.querySelector('.ver-detalle').dataset.id;
          verProducto(id);
        });
      });
    }

    function verProducto(id){
      const producto = productos.find(p => p.id === id);
      if (!producto) return;
      
      $("#productoNombre").textContent = producto.nombre;
      $("#productoPrecio").textContent = money(producto.precio);
      $("#productoStock").textContent = producto.stock > 0 ? `Stock: ${producto.stock} unidades` : 'Agotado';
      $("#productoStock").className = `producto-stock ${producto.stock > 0 ? 'disponible' : 'agotado'}`;
      $("#productoCategoria").textContent = `Categor√≠a: ${producto.cat}`;
      $("#productoImg").src = producto.img;
      $("#productoImg").alt = producto.nombre;
      $("#productoQty").value = '1';
      $("#productoQty").max = producto.stock;
      
      const descripciones = {
        'pan-molde': 'Nuestro pan de molde sin gluten es perfecto para tus desayunos y meriendas. Elaborado con ingredientes naturales, sin conservantes y con todo el sabor del pan tradicional.',
        'galleta-avena': 'Crujientes galletas de arroz ideales para snack saludable. Bajas en calor√≠as y perfectas para llevar contigo a cualquier lugar.',
        'pack-desayuno': 'Combo especial que incluye pan de molde, galletas y mermelada sin az√∫car a√±adido. Todo lo necesario para un desayuno completo y delicioso.',
        'brownie-proteico': 'Brownie rico en prote√≠nas, perfecto para deportistas y personas que buscan una opci√≥n saludable sin sacrificar el sabor.',
        'mix-semillado': 'Pan semillado con mix de ch√≠a, linaza y s√©samo. Rico en fibra y omega-3, ideal para una alimentaci√≥n balanceada.',
        'cookies-chips': 'Deliciosas cookies con chips de chocolate, crocantes por fuera y suaves por dentro. El treat perfecto sin gluten.'
      };
      
      $("#productoDesc").textContent = descripciones[producto.id] || 'Producto artesanal sin gluten, elaborado con ingredientes de primera calidad. Perfecto para cel√≠acos y personas que buscan una alimentaci√≥n m√°s saludable.';
      
      const badge = $("#productoBadge");
      badge.innerHTML = '';
      
      if (producto.stock === 0) {
        badge.textContent = 'AGOTADO';
        badge.style.background = 'var(--err)';
      } else if (producto.stock < 3) {
        badge.textContent = '√öLTIMAS UNIDADES';
        badge.style.background = 'var(--warn)';
      } else if (producto.cat === 'Pack') {
        badge.textContent = 'OFERTA ESPECIAL';
        badge.className = 'producto-badge badge-oferta';
      } else if (producto.precio < 3000) {
        badge.textContent = 'POPULAR';
        badge.className = 'producto-badge badge-popular';
      } else {
        badge.textContent = 'NUEVO';
        badge.className = 'producto-badge badge-nuevo';
      }
      
      $("#btnAgregarDetalle").dataset.id = id;
      go('producto');
    }

    $("#qtyMenos").addEventListener('click', () => {
      const input = $("#productoQty");
      const current = parseInt(input.value);
      if (current > 1) {
        input.value = current - 1;
      }
    });

    $("#qtyMas").addEventListener('click', () => {
      const input = $("#productoQty");
      const producto = productos.find(p => p.id === $("#btnAgregarDetalle").dataset.id);
      const current = parseInt(input.value);
      if (producto && current < producto.stock && current < 10) {
        input.value = current + 1;
      }
    });

    $("#btnAgregarDetalle").addEventListener('click', function() {
      const productoId = this.dataset.id;
      const cantidad = parseInt($("#productoQty").value);
      const producto = productos.find(p => p.id === productoId);
      
      if (!producto || producto.stock === 0) return;
      
      const cart = getCart();
      const item = cart.find(x => x.id === productoId);
      
      if (item) {
        if (item.qty + cantidad <= producto.stock) {
          item.qty += cantidad;
        } else {
          alert("Stock insuficiente");
          return;
        }
      } else {
        cart.push({id: productoId, qty: cantidad});
      }
      
      setCart(cart);
      
      this.classList.add('agregado-exitoso');
      setTimeout(() => {
        this.classList.remove('agregado-exitoso');
      }, 600);
      
      $("#cartCount").textContent = cantidades().items;
      updateCartBadge();
    });

    $("#prevPag").onclick=()=>{ if(pag>1){pag--; pintarCatalogo()} };
    $("#nextPag").onclick=()=>{ if(pag<cacheFiltro.pages){pag++; pintarCatalogo()} };
    $("#btnBuscar").onclick=$("#aplicarFiltros").onclick=()=>{pag=1; pintarCatalogo()};
    $("#q").addEventListener("keydown",e=>{if(e.key==="Enter"){pag=1;pintarCatalogo()}});

    function agregar(id){
      const p=productos.find(x=>x.id===id);
      if(!p||!p.stock) return;
      const cart=getCart();
      const i=cart.find(x=>x.id===id);
      if(i){ if(i.qty<p.stock) i.qty++; }
      else cart.push({id,qty:1});
      setCart(cart);
      $("#cartCount").textContent=cantidades().items;
      updateCartBadge();
    }

    function cantidades(){
      const cart=getCart();
      let items=0,subtotal=0;
      cart.forEach(i=>{
        const p=productos.find(x=>x.id===i.id);
        items+=i.qty;
        subtotal+=p.precio*i.qty;
      });
      return {items,subtotal,shipping:cart.length?4000:0,total:cart.length?subtotal+4000:0};
    }

    function pintarCarrito(){
      const cart=getCart();
      const cont=$("#carritoLista");
      cont.innerHTML="";
      if(!cart.length){
        cont.innerHTML=`<div class="msg warn">El carrito est√° vac√≠o</div>`;
        $('#btnConfirmarPedido').disabled=true;
      }else $('#btnConfirmarPedido').disabled=false;

      cart.forEach(i=>{
        const p=productos.find(x=>x.id===i.id);
        const li=document.createElement("div");
        li.className="carrito-item";
        li.innerHTML=`
          <img src="${p.img}" alt="${p.nombre}"/>
          <div class="info">
            <div class="name">${p.nombre}</div>
            <div class="unit">${money(p.precio)}</div>
          </div>
          <div class="qty">
            <button class="less" data-id="${i.id}">‚àí</button>
            <input value="${i.qty}" readonly/>
            <button class="plus" data-id="${i.id}">+</button>
          </div>
          <div class="sub">${money(i.qty*p.precio)}</div>
          <button class="del" data-id="${i.id}">Eliminar</button>
        `;
        cont.appendChild(li);
      });

      cont.querySelectorAll(".plus").forEach(b=>b.addEventListener("click",()=>{
        const id=b.dataset.id;
        const p=productos.find(x=>x.id===id);
        const cart=getCart();
        const i=cart.find(x=>x.id===id);
        if(i.qty<p.stock){ i.qty++; setCart(cart); pintarCarrito(); }
        else { $("#msgCarrito").textContent="Stock insuficiente"; }
      }));
      cont.querySelectorAll(".less").forEach(b=>b.addEventListener("click",()=>{
        const id=b.dataset.id;
        const cart=getCart();
        const i=cart.find(x=>x.id===id);
        i.qty=Math.max(1,i.qty-1);
        setCart(cart); pintarCarrito();
      }));
      cont.querySelectorAll(".del").forEach(b=>b.addEventListener("click",()=>{
        const id=b.dataset.id;
        setCart(getCart().filter(x=>x.id!==id));
        pintarCarrito();
      }));

      const k=cantidades();
      $("#pillSubtotal").textContent=money(k.subtotal);
      $("#pillDespacho").textContent="Despacho: "+money(k.shipping);
      $("#pillTotal").textContent="Total: "+money(k.total);
      $("#cartCount").textContent=k.items;
      updateCartBadge();
    }

    function checkoutResumenTexto(){
      const cart=getCart();
      const lines=[];
      lines.push("Pedido provisional");
      lines.push("-----------------");
      cart.forEach(i=>{
        const p=productos.find(x=>x.id===i.id);
        lines.push(`${i.qty} √ó ${p.nombre} (${money(p.precio)}) ‚Üí ${money(i.qty*p.precio)}`);
      });
      const k=cantidades();
      lines.push("");
      lines.push(`Subtotal: ${money(k.subtotal)}`);
      lines.push(`Despacho: ${money(k.shipping)}`);
      lines.push(`Total:    ${money(k.total)}`);
      return {txt:lines.join("\n"),k};
    }

    function pintarCheckout(){
      const cart=getCart();
      $("#ckWarn").classList.add("hidden");
      $("#ckEmpty").classList.toggle("hidden",!!cart.length);
      const {txt,k}=checkoutResumenTexto();
      $("#resumenTxt").textContent=txt;
      $("#ckSubtotal").textContent=money(k.subtotal);
      $("#ckDespacho").textContent="Despacho: "+money(k.shipping);
      $("#ckTotal").textContent="Total: "+money(k.total);
    }

    $("#btnConfirmarPedido").onclick=()=>go("checkout");

    $("#goPasarela").onclick=()=>{
      if(!getCart().length){$("#ckEmpty").classList.remove("hidden");return}
      if(!$("#addr").value.trim()){ $("#ckWarn").classList.remove("hidden"); return }
      go("pasarela");
      $("#retornoText").textContent="‚Äî";
    };

    $$(".pay-option").forEach(b=>b.addEventListener("click",()=>{
      const result=b.dataset.result;
      $("#retornoText").textContent=result;
      if(result==="AUTHORIZED"){
        localStorage.setItem("lr:lastOrderStatus","Pagado");
        go("resultado");
        $("#resOK").classList.remove("hidden");
        $("#resREJ").classList.add("hidden");
        $("#resERR").classList.add("hidden");
        localStorage.setItem(LS_KEY,"[]");
      }else if(result==="REJECTED"){
        localStorage.setItem("lr:lastOrderStatus","Pendiente de pago");
        go("resultado");
        $("#resOK").classList.add("hidden");
        $("#resREJ").classList.remove("hidden");
        $("#resERR").classList.add("hidden");
      }else{
        go("resultado");
        $("#resOK").classList.add("hidden");
        $("#resREJ").classList.add("hidden");
        $("#resERR").classList.remove("hidden");
      }
    }));

    $("#btnActualizarSeg").onclick=()=>{
      const hist=$("#segHist");
      hist.innerHTML="";
      const estados=["Confirmado","En preparaci√≥n","Enviado"];
      const now=new Date();
      estados.forEach((e,i)=>{
        const li=document.createElement("li");
        li.textContent=`${new Date(now-3600000*(estados.length-i)).toLocaleTimeString()} ‚Äî ${e}`;
        hist.appendChild(li);
      });
      $("#segEstado").textContent="Estado actual: Enviado";
    };

    seedFiltros();
    updateUserSection();
    go(location.hash.replace("#","")||"catalogo");
    updateCartBadge();

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-dropdown')) {
        const dropdown = $('.dropdown-menu');
        if (dropdown) dropdown.classList.add('hidden');
      }
    });
  </script>
</body>
</html>